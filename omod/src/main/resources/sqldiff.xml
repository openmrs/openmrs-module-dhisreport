<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
        <help>
                USE:
                The diffs are ordered by datamodel version number.
                The script can be run in a top down fashion and is
                expected to not failor overwrite old data

                EXPECT:
                - "use business-database-name;" was called prior to
                calling this script
        </help>
        <diff>
                <version>1.0</version>
                <author>Apurv Mehra</author>
                <date>Jan 3rd 2013</date>
                <description>
                        Create tables for SDMX if they do not exist
                </description>
                <sql>


						CREATE TABLE IF NOT EXISTS `dhisreport_dataelement` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `de_name` varchar(255) NOT NULL,
						  `uid` varchar(255) NOT NULL,
						  `code` varchar(255) NOT NULL,
						  PRIMARY KEY (`id`),
						  UNIQUE KEY `code` (`code`),
						  UNIQUE KEY `uid` (`uid`)
						) ENGINE=InnoDB AUTO_INCREMENT=813 DEFAULT CHARSET=latin1;


						CREATE TABLE IF NOT EXISTS `dhisreport_disaggregation` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `disagg_name` varchar(255) NOT NULL,
						  `uid` varchar(255) NOT NULL,
						  `code` varchar(255) NOT NULL,
						  PRIMARY KEY (`id`),
						  UNIQUE KEY `uid` (`uid`),
						  UNIQUE KEY `code` (`code`)
						) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;


						CREATE TABLE IF NOT EXISTS `dhisreport_report_definition` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `report_name` varchar(255) NOT NULL,
						  `uid` varchar(255) NOT NULL,
						  `code` varchar(255) NOT NULL,
						  PRIMARY KEY (`id`),
						  UNIQUE KEY `code` (`code`),
						  UNIQUE KEY `uid` (`uid`)
						) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=latin1;


						CREATE TABLE IF NOT EXISTS `dhisreport_datavalue_template` (
						  `id` int(11) NOT NULL AUTO_INCREMENT,
						  `report_definition_id` int(11) NOT NULL,
						  `dataelement_id` int(11) NOT NULL,
						  `disaggregation_id` int(11) NOT NULL,
						  `query` text,
						  PRIMARY KEY (`id`),
						  KEY `fk_dataelement_datavaluetemplate` (`dataelement_id`),
						  KEY `fk_disaggregation_datavaluetemplate` (`disaggregation_id`),
						  KEY `fk_report_definition_datavaluetemplate` (`report_definition_id`),
						  CONSTRAINT `fk_dataelement_datavaluetemplate` FOREIGN KEY (`dataelement_id`) REFERENCES `dhisreport_dataelement` (`id`),
						  CONSTRAINT `fk_disaggregation_datavaluetemplate` FOREIGN KEY (`disaggregation_id`) REFERENCES `dhisreport_disaggregation` (`id`),
						  CONSTRAINT `fk_report_definition_datavaluetemplate` FOREIGN KEY (`report_definition_id`) REFERENCES `dhisreport_report_definition` (`id`)
						) ENGINE=InnoDB AUTO_INCREMENT=828 DEFAULT CHARSET=latin1;

                </sql>
        </diff>

        <diff>
			<version>1.1</version>
			<author>Apurv Mehra</author>
			<date>Feb 15th 2014</date>
			<description>
				Added 'period type' to report definition table
			</description>
			<sql>
				ALTER TABLE `dhisreport_report_definition`
 				ADD `periodType` varchar(16) DEFAULT NULL;
			</sql>
		</diff>
	<diff>
		<version>1.2</version>
		<author>Sri Maurya Kummamuru</author>
		<date>Mar 16th 2016</date>
		<description>
			Added 'reportingReportUuid' to report definition table
		</description>
		<sql>
			ALTER TABLE `dhisreport_report_definition`
			ADD `reportingreportuuid` char(38) DEFAULT NULL;
		</sql>
	</diff>

        <diff>
		<version>1.3</version>
		<author>Choxmi Sathsara</author>
		<date>June 26th 2017</date>
		<description>
			Added 'default_report_query' and 'mapped_definition_id' to datavalue_template table
		</description>
		<sql>
			ALTER TABLE `dhisreport_datavalue_template`
			ADD `defaultreportquery` text DEFAULT NULL,
                        ADD `mappeddefinitionlabel` text DEFAULT NULL,
                        ADD `mappeddefinitionuuid` text DEFAULT NULL;
		</sql>
	</diff>
	<diff>
		<version>2.1</version>
		<author>Jayasanka Weerasinghe</author>
		<date>July 9th 2020</date>
		<description>
			Update the current model to support ADX desegregations
		</description>
		<sql>
			CREATE TABLE IF NOT EXISTS `dhisreport_dataset` (
			`id` int(11) NOT NULL AUTO_INCREMENT,
			`name` varchar(230) NOT NULL,
			`uid` varchar(11) NOT NULL,
			`code` varchar(50) NOT NULL,
			`periodType` varchar(50) NOT NULL,
			`reportUuid` varchar(45),
			PRIMARY KEY (`id`),
			UNIQUE KEY `uid` (`uid`)
			) ENGINE=InnoDB AUTO_INCREMENT=813 DEFAULT CHARSET=latin1;

			ALTER TABLE dhisreport_dataelement CHANGE de_name name VARCHAR(230);
			ALTER TABLE dhisreport_dataelement MODIFY COLUMN code VARCHAR(50);
			ALTER TABLE dhisreport_dataelement MODIFY COLUMN uid VARCHAR(11);

			CREATE TABLE IF NOT EXISTS `dhisreport_category` (
			`id` INT NOT NULL AUTO_INCREMENT,
			`uid` VARCHAR(11) NOT NULL,
			`code` VARCHAR(50) NOT NULL,
			`name` VARCHAR(230) NOT NULL,
			UNIQUE KEY `uid` (`uid`),
			PRIMARY KEY (`id`))
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_category_option` (
			`id` INT NOT NULL AUTO_INCREMENT,
			`uid` VARCHAR(11) NOT NULL,
			`code` VARCHAR(50) NOT NULL,
			`name` VARCHAR(230) NOT NULL,
			UNIQUE KEY `uid` (`uid`),
			PRIMARY KEY (`id`))
			ENGINE = InnoDB;

			DROP TABLE `dhisreport_datavalue_template`;
			DROP TABLE `dhisreport_disaggregation`;
			DROP TABLE `dhisreport_report_definition`;

			CREATE TABLE IF NOT EXISTS `dhisreport_datavalue_template` (
			`id` INT NOT NULL AUTO_INCREMENT,
			`dataset_id` INT NOT NULL,
			`dataelement_id` INT NOT NULL,
			`reportIndicatorUuid` VARCHAR(36) NULL,
			PRIMARY KEY (`id`),
			CONSTRAINT `fk_datavalue_template_dataset`
			FOREIGN KEY (`dataset_id`)
			REFERENCES `dhisreport_dataset` (`id`)
			ON DELETE CASCADE,
			CONSTRAINT `fk_datavalue_template_dataelement`
			FOREIGN KEY (`dataelement_id`)
			REFERENCES `dhisreport_dataelement` (`id`)
			ON DELETE CASCADE)
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_disaggregation` (
			`id` INT NOT NULL AUTO_INCREMENT,
			`category_id` INT NOT NULL,
			`category_option_id` INT NOT NULL,
			PRIMARY KEY (`id`),
			CONSTRAINT `fk_disaggregation_combination_category`
			FOREIGN KEY (`category_id`)
			REFERENCES `dhisreport_category` (`id`)
			ON DELETE CASCADE,
			CONSTRAINT `fk_disaggregation_combination_category_option`
			FOREIGN KEY (`category_option_id`)
			REFERENCES `dhisreport_category_option` (`id`)
			ON DELETE CASCADE)
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_dataset_dataelement` (
			`dataset_id` INT NOT NULL,
			`dataelement_id` INT NOT NULL,
			PRIMARY KEY (`dataset_id`, `dataelement_id`),
			CONSTRAINT `fk_dataset_dataelement_dataset`
			FOREIGN KEY (`dataset_id`)
			REFERENCES `dhisreport_dataset` (`id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION,
			CONSTRAINT `fk_dataset_dataelement_dataelement`
			FOREIGN KEY (`dataelement_id`)
			REFERENCES `dhisreport_dataelement` (`id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION)
			ENGINE = InnoDB;

			CREATE TABLE IF NOT EXISTS `dhisreport_datavalue_template_disaggregation` (
			`datavalue_template_id` INT NOT NULL,
			`disaggregation_id` INT NOT NULL,
			PRIMARY KEY (`datavalue_template_id`, `disaggregation_id`),
			CONSTRAINT `fk_datavalue_template_has_disaggregation_data_value_template`
			FOREIGN KEY (`datavalue_template_id`)
			REFERENCES `dhisreport_datavalue_template` (`id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION,
			CONSTRAINT `fk_datavalue_template_has_disaggregation_disaggregation`
			FOREIGN KEY (`disaggregation_id`)
			REFERENCES `dhisreport_disaggregation` (`id`)
			ON DELETE CASCADE
			ON UPDATE NO ACTION)
			ENGINE = InnoDB;
		</sql>
	</diff>
</sqldiff>
